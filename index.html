<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Space Dodger - Gun Upgrade Edition</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: black;
    }

    canvas {
      display: block;
      margin: 0 auto;
    }

    #score {
      color: white;
      font-family: Arial;
      font-size: 20px;
      position: absolute;
      top: 10px;
      left: 10px;
    }

    #upgradeMenu {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      font-family: Arial;
      z-index: 2;
    }

    #upgradeMenu h2 {
      margin-top: 0;
    }

    .upgrade-button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background: #222;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="score">Score: 0</div>
  <canvas id="gameCanvas" width="800" height="500"></canvas>

  <div id="upgradeMenu">
    <h2>Upgrade Shop</h2>
    <p>You scored <span id="finalScore">0</span> points</p>
    <p>Select your weapon:</p>
    <button class="upgrade-button" onclick="selectWeapon('basic')">ðŸ”« Basic Blaster (Free)</button><br>
    <button class="upgrade-button" onclick="selectWeapon('shotgun')">ðŸ’¥ Shotgun (20 points) <span id="shotgunStatus"></span></button><br>
    <button class="upgrade-button" onclick="selectWeapon('laser')">ðŸ”¥ Laser Gun (30 points) <span id="laserStatus"></span></button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const spaceshipImg = new Image();
    spaceshipImg.src = "spaceship.png";

    const keys = {};
    window.addEventListener("keydown", e => keys[e.key] = true);
    window.addEventListener("keyup", e => keys[e.key] = false);

    let weapon = "basic";
    let unlockedWeapons = [];
    let score = 0;
    let playerShots = [];
    let enemies = [];
    let stars = [];
    let lives = 3;
    let player;
    let gameOver = false;
    let frame = 0;

    function saveData() {
      const gameData = {
        unlockedWeapons: unlockedWeapons,
        selectedWeapon: weapon
      };
      localStorage.setItem("spaceDodgerData", JSON.stringify(gameData));
    }

    function loadData() {
      const data = localStorage.getItem("spaceDodgerData");
      if (data) {
        const parsed = JSON.parse(data);
        unlockedWeapons = parsed.unlockedWeapons || ["basic"];
        weapon = parsed.selectedWeapon || "basic";
      } else {
        unlockedWeapons = ["basic"];
        weapon = "basic";
      }
    }

    function resetGame() {
      player = {
        x: 50,
        y: canvas.height / 2,
        width: 40,
        height: 40,
        speed: 4,
        canShoot: true,
        shootCooldown: 300
      };

      playerShots = [];
      enemies = [];

      stars = Array.from({ length: 100 }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 2,
        speed: 0.5 + Math.random()
      }));

      gameOver = false;
      frame = 0;
      score = 0;
      lives = 3;

      document.getElementById("score").textContent = "Score: " + score;
      document.getElementById("upgradeMenu").style.display = "none";

      requestAnimationFrame(gameLoop);
    }

    function drawStars() {
      ctx.fillStyle = "white";
      stars.forEach(star => {
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
        ctx.fill();
        star.x -= star.speed;
        if (star.x < 0) {
          star.x = canvas.width;
          star.y = Math.random() * canvas.height;
        }
      });
    }

    function updatePlayer() {
      if (keys["ArrowUp"] || keys["w"]) player.y -= player.speed;
      if (keys["ArrowDown"] || keys["s"]) player.y += player.speed;
      if (keys["ArrowLeft"] || keys["a"]) player.x -= player.speed;
      if (keys["ArrowRight"] || keys["d"]) player.x += player.speed;

      player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
      player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));

      if ((keys[" "] || keys["Spacebar"]) && player.canShoot) {
        shoot();
        player.canShoot = false;
        setTimeout(() => { player.canShoot = true; }, player.shootCooldown);
      }
    }

    function drawPlayer() {
      ctx.drawImage(spaceshipImg, player.x, player.y, player.width, player.height);
    }

    function shoot() {
      switch (weapon) {
        case "basic":
          playerShots.push(createShot(player.x + player.width, player.y + player.height / 2 - 2, 10, 4, 6));
          break;
        case "shotgun":
          for (let i = -1; i <= 1; i++) {
            playerShots.push(createShot(player.x + player.width, player.y + player.height / 2 - 2 + i * 5, 10, 4, 6));
          }
          break;
        case "laser":
          playerShots.push(createShot(player.x + player.width, player.y + player.height / 2 - 1, 14, 2, 10, "cyan"));
          break;
      }
    }

    function createShot(x, y, w, h, speed, color = "lime") {
      return { x, y, width: w, height: h, speed, color };
    }

    function updateShots() {
      playerShots.forEach(s => s.x += s.speed);
      playerShots = playerShots.filter(s => s.x < canvas.width);

      enemies.forEach((enemy, ei) => {
        playerShots.forEach((s, si) => {
          if (
            s.x < enemy.x + enemy.width &&
            s.x + s.width > enemy.x &&
            s.y < enemy.y + enemy.height &&
            s.y + s.height > enemy.y
          ) {
            enemies.splice(ei, 1);
            playerShots.splice(si, 1);
            score += 10;
            document.getElementById("score").textContent = "Score: " + score;
          }
        });
      });
    }

    function drawShots() {
      playerShots.forEach(s => {
        ctx.fillStyle = s.color;
        ctx.fillRect(s.x, s.y, s.width, s.height);
      });
    }

    function spawnEnemy() {
      enemies.push({
        x: canvas.width,
        y: Math.random() * (canvas.height - 30),
        width: 30,
        height: 30,
        speed: 2
      });
    }

    function updateEnemies() {
      enemies.forEach(e => e.x -= e.speed);

      for (let i = enemies.length - 1; i >= 0; i--) {
        const e = enemies[i];
        if (e.x + e.width < 0) enemies.splice(i, 1);

        if (
          e.x < player.x + player.width &&
          e.x + e.width > player.x &&
          e.y < player.y + player.height &&
          e.y + e.height > player.y
        ) {
          enemies.splice(i, 1);
          lives--;
          if (lives <= 0) {
            updateUpgradeMenu();
          }
        }
      }
    }

    function drawEnemies() {
      ctx.fillStyle = "red";
      enemies.forEach(e => {
        ctx.fillRect(e.x, e.y, e.width, e.height);
      });
    }

    function drawUI() {
      ctx.fillStyle = "lime";
      ctx.font = "16px Arial";
      ctx.fillText("Lives: " + lives, canvas.width - 100, 20);
    }

    function updateUpgradeMenu() {
      gameOver = true;
      document.getElementById("finalScore").textContent = score;
      document.getElementById("shotgunStatus").textContent = unlockedWeapons.includes("shotgun") ? "âœ… Unlocked" : "";
      document.getElementById("laserStatus").textContent = unlockedWeapons.includes("laser") ? "âœ… Unlocked" : "";
      document.getElementById("upgradeMenu").style.display = "block";
    }

    function selectWeapon(selected) {
      if (selected === "shotgun" && !unlockedWeapons.includes("shotgun")) {
        if (score < 20) return alert("Not enough points!");
        unlockedWeapons.push("shotgun");
      }

      if (selected === "laser" && !unlockedWeapons.includes("laser")) {
        if (score < 30) return alert("Not enough points!");
        unlockedWeapons.push("laser");
      }

      weapon = selected;
      saveData();
      resetGame();
    }

    function gameLoop() {
      if (gameOver) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawStars();
      updatePlayer();
      updateShots();
      updateEnemies();

      drawPlayer();
      drawShots();
      drawEnemies();
      drawUI();

      frame++;
      if (frame % 60 === 0) spawnEnemy();

      requestAnimationFrame(gameLoop);
    }

    spaceshipImg.onload = () => {
      loadData();
      resetGame();
    };
  </script>
</body>
</html>
